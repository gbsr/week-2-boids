(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))a(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const l of i.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&a(l)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();const tt={triangle:{type:"path",anchor:"tip",forward:"+x",scale:1,points:[[0,0],[-10,4],[-10,-4]]},circle:{type:"circle",anchor:"center",forward:"+x",scale:1,radius:4},diamond:{type:"path",anchor:"center",forward:"+x",scale:1,points:[[8,0],[0,4],[-8,0],[0,-4]]},cross:{type:"path",anchor:"center",forward:"+x",scale:1,points:[[-10,-2],[-2,-2],[-2,-6],[2,-6],[2,-2],[6,-2],[6,2],[2,2],[2,6],[-2,6],[-2,2],[-10,2]]},cake:{type:"path",anchor:"tip",forward:"+x",scale:1,points:[[5,0],[-10,8],[-12,3],[-12,-3],[-10,-8]]},kite:{type:"path",anchor:"center",forward:"+x",scale:1,points:[[3,0],[0,3],[-7,0],[0,-3]]},chevron:{type:"path",anchor:"tip",forward:"+x",scale:1,points:[[0,0],[-8,6],[-6,6],[-2,2],[-2,-2],[-6,-6],[-8,-6]]},leaf:{type:"path",anchor:"center",forward:"+x",scale:1,points:[[9,0],[6,3.5],[0,5],[-8,2],[-9,0],[-8,-2],[0,-5],[6,-3.5]]},capsule:{type:"path",anchor:"center",forward:"+x",scale:1,points:[[8,-3],[8,3],[6,5],[-6,5],[-8,3],[-8,-3],[-6,-5],[6,-5]]},wedge:{type:"path",anchor:"tip",forward:"+x",scale:1,points:[[0,0],[-10,7],[-14,0],[-10,-7]]},particle:{type:"circle",anchor:"center",forward:"+x",scale:1,radius:1},dot:{type:"circle",anchor:"center",forward:"+x",scale:1,radius:.2}},ne={boidCount:{default:980,group:"Simulation",label:"Number of Boids",control:"slider",slider:{min:0,max:1200,step:1},affects:"boid-structure"},perceptionRadius:{default:20,group:"Simulation",label:"Perception",control:"none",slider:{min:5,max:200,step:1}},attractMouse:{default:!1,group:"Interaction",label:"Attract Mouse",control:"checkbox"},repelMouse:{default:!1,group:"Interaction",label:"Repel Mouse",control:"checkbox"},showMouseRadius:{default:!1,group:"Interaction",label:"Show Mouse Radius",control:"checkbox"},spacer_mouseCheckBoxes:{default:0,group:"Interaction",control:"spacer"},mouseRadius:{default:250,group:"Interaction",label:"Mouse Radius",control:"slider",slider:{min:1,max:500,step:1}},mouseInfluence:{default:.25,group:"Interaction",label:"Mouse Influence",control:"slider",slider:{min:0,max:1,step:.01}},spacer_mouseRadius:{default:0,control:"spacer",group:"Interaction"},mouseAttractionWeight:{default:5,group:"Interaction",label:"Mouse Attraction",control:"none",slider:{min:0,max:500,step:.1}},mouseRepelWeight:{default:25,group:"Interaction",label:"Mouse Repel",control:"none",slider:{min:0,max:500,step:.1}},separationWeight:{default:.75,group:"Flocking",label:"Separation",control:"slider",slider:{min:0,max:3,step:.001}},separationRadius:{default:5,group:"Flocking",label:"Radius",control:"slider",slider:{min:0,max:380,step:.5}},spacer_separation:{default:0,group:"Flocking",control:"spacer"},alignmentWeight:{default:.05,group:"Flocking",label:"Alignment",control:"slider",slider:{min:0,max:3,step:.001}},alignmentRadius:{default:30,group:"Flocking",label:"Radius",control:"slider",slider:{min:0,max:380,step:.5}},spacer_alignment:{default:0,group:"Flocking",control:"spacer"},cohesionWeight:{default:.92,group:"Flocking",label:"Cohesion",control:"slider",slider:{min:0,max:3,step:.001}},cohesionRadius:{default:320,group:"Flocking",label:"Radius",control:"slider",slider:{min:0,max:380,step:.5}},spacer_cohesion:{default:0,group:"Flocking",control:"spacer"},maxForce:{default:10,group:"Flocking",label:"Max force",control:"slider",slider:{min:0,max:50,step:.001}},spacer_MaxForce:{default:0,group:"Flocking",control:"spacer"},flockDriftStrength:{default:3,group:"Flocking",label:"Flock Drift",control:"slider",slider:{min:0,max:10,step:.001}},spacer:{default:0,group:"Flocking",control:"spacer"},speedBoostAtEdges:{default:.3,group:"Flocking",label:"Accelerate when far from flock",control:"slider",slider:{min:0,max:1,step:.001}},turnBoostAtEdges:{default:1,group:"Flocking",label:"Turn boost when far from flock",control:"slider",slider:{min:0,max:2,step:.001}},maxSpeed:{default:20,group:"Movement",label:"Max speed",control:"slider",slider:{min:1,max:500,step:.001}},turnRate:{default:10,group:"Movement",label:"Turn rate",control:"slider",slider:{min:.01,max:150,step:.1}},maxWanderForce:{default:20,group:"Movement",label:"Wander force",control:"slider",slider:{min:0,max:50,step:.001}},spacer_wander:{default:0,group:"Movement",control:"spacer"},spacer_wrapEdges:{default:0,group:"Edge",control:"spacer"},boundaryMargin:{default:200,group:"Edge",label:"Margin",control:"slider",slider:{min:0,max:400,step:10}},boundaryStrength:{default:15,group:"Edge",label:"Repel Edge",control:"slider",slider:{min:0,max:300,step:.1}},size:{default:1,group:"Render",label:"Size",control:"slider",slider:{min:.01,max:10,step:.01}},trailLength:{default:.15,group:"Render",label:"Trail length",control:"slider",slider:{min:0,max:1,step:.01}},trailAlpha:{default:1,group:"Render",label:"Trail alpha",control:"none",slider:{min:0,max:1,step:.01}},trailStep:{default:0,group:"Render",label:"Trail step",control:"slider",slider:{min:0,max:30,step:1}},shadowSize:{default:4,group:"Render",label:"Shadow size",control:"slider",slider:{min:0,max:10,step:.1}},shadowOpacity:{default:1,group:"Render",label:"Shadow opacity",control:"slider",slider:{min:0,max:1,step:.01}},randomBoidColors:{default:!1,group:"Render",label:"Random boid colors",control:"checkbox"},randomTrailColors:{default:!1,group:"Render",label:"Random trail colors",control:"checkbox"},theme:{default:"dot",group:"Render",label:"Theme",control:"dropdown",dropdown:{options:["triangle","circle","diamond","cross","cake","kite","chevron","leaf","particle","dot"]},affects:"render-cache"},visualizePerception:{default:!1,group:"Debug - Perception",label:"Show perception radius",control:"none"},perceptionColor:{default:"#00ff00",group:"Debug - Perception",label:"Perception color",control:"none"},perceptionLineWidth:{default:1,group:"Debug - Perception",label:"Perception line width",control:"none",slider:{min:.1,max:5,step:.1}},perceptionAlpha:{default:.3,group:"Debug - Perception",label:"Perception alpha",control:"none",slider:{min:0,max:.5,step:1e-4}},visualizeCohesionRadius:{default:!1,group:"Debug - Cohesion",label:"Show cohesion radius",control:"checkbox"},visualizeCohesionToNeighbors:{default:!1,group:"Debug - Cohesion",label:"Show cohesion → neighbors",control:"checkbox"},cohesionRadiusColor:{default:"#ff00ff",group:"Debug - Cohesion",label:"Cohesion radius color",control:"none"},cohesionRadiusLineWidth:{default:4,group:"Debug - Cohesion",label:"Cohesion line width",control:"slider",slider:{min:.001,max:3,step:.001}},cohesionRadiusAlpha:{default:.03,group:"Debug - Cohesion",label:"Cohesion alpha",control:"slider",slider:{min:0,max:.05,step:1e-4}},visualizeAlignmentRadius:{default:!1,group:"Debug - Alignment",label:"Show alignment radius",control:"checkbox"},visualizeAlignmentToNeighbors:{default:!1,group:"Debug - Alignment",label:"Show alignment → neighbors",control:"checkbox"},alignmentRadiusColor:{default:"#7fe29c",group:"Debug - Alignment",label:"Alignment radius color",control:"none"},alignmentRadiusLineWidth:{default:1,group:"Debug - Alignment",label:"Alignment line width",control:"slider",slider:{min:.001,max:3,step:.01}},alignmentRadiusAlpha:{default:.03,group:"Debug - Alignment",label:"Alignment alpha",control:"slider",slider:{min:0,max:.05,step:1e-4}},visualizeSeparationRadius:{default:!1,group:"Debug - Separation",label:"Show separation radius",control:"checkbox"},visualizeSeparationToNeighbors:{default:!1,group:"Debug - Separation",label:"Show separation → neighbors",control:"checkbox"},separationRadiusColor:{default:"#ff0000",group:"Debug - Separation",label:"Separation radius color",control:"none"},separationRadiusLineWidth:{default:4,group:"Debug - Separation",label:"Separation line width",control:"slider",slider:{min:.01,max:3,step:.01}},separationRadiusAlpha:{default:.03,group:"Debug - Separation",label:"Separation alpha",control:"slider",slider:{min:0,max:.05,step:1e-4}},debugSampleStride:{default:4,group:"Debug",label:"Debug sample stride",control:"none",slider:{min:1,max:10,step:1}},maxDebugNeighbors:{default:200,group:"Debug",label:"Max debug neighbors",control:"none",slider:{min:1,max:450,step:1}}};function ot(){const e={};return Object.keys(ne).forEach(n=>{e[n]=ne[n].default}),e}const o={fsm:{state:"idle"},needsBoidReinit:!1,needsTrailReset:!1,needsFullCanvasReset:!1,params:ot(),mouse:{x:0,y:0,inside:!1},arrays:{position:{x:[],y:[]},velocity:{x:[],y:[]}},viewport:{width:800,height:600}},Y={x:0,y:0,angle:Math.random()*Math.PI*2};function oe(e){const n=Math.hypot(e.x,e.y)||1;return{x:e.x/n,y:e.y/n}}function nt(e,n){const t=Math.hypot(e.x,e.y);if(t>n){const a=n/t;return{x:e.x*a,y:e.y*a}}return e}function at(e,n){return Math.hypot(e.x-n.x,e.y-n.y)}function st(e,n,t){return{x:e.x+(n.x-e.x)*t,y:e.y+(n.y-e.y)*t}}function N(e,n=1){const t=e.replace("#",""),a=parseInt(t,16);if(t.length===3){const c=parseInt(t[0]+t[0],16),h=parseInt(t[1]+t[1],16),b=parseInt(t[2]+t[2],16);return`rgba(${c}, ${h}, ${b}, ${n})`}const s=a>>16&255,i=a>>8&255,l=a&255;return`rgba(${s}, ${i}, ${l}, ${n})`}function Oe(e,n){const t=e.getBoundingClientRect();return{x:n.clientX-t.left,y:n.clientY-t.top}}function it(e,n,t){!o.params.visualizeAlignmentRadius&&!o.params.visualizeAlignmentToNeighbors||(o.params.visualizeAlignmentRadius&&(t.beginPath(),t.arc(e.x,e.y,o.params.alignmentRadius,0,Math.PI*2),t.strokeStyle=N(o.params.alignmentRadiusColor,o.params.alignmentRadiusAlpha*4),t.fillStyle=N(o.params.alignmentRadiusColor,o.params.alignmentRadiusAlpha*1.2),t.lineWidth=o.params.alignmentRadiusLineWidth,t.fill(),t.stroke()),o.params.visualizeAlignmentToNeighbors&&n.forEach(a=>{t.beginPath(),t.moveTo(e.x,e.y),t.lineTo(a.x,a.y),t.strokeStyle=N(o.params.alignmentRadiusColor,o.params.alignmentRadiusAlpha*4),t.lineWidth=o.params.alignmentRadiusLineWidth,t.stroke()}))}function rt(e,n,t){!o.params.visualizeCohesionRadius&&!o.params.visualizeCohesionToNeighbors||(o.params.visualizeCohesionRadius&&(t.beginPath(),t.arc(e.x,e.y,o.params.cohesionRadius,0,Math.PI*2),t.strokeStyle=N(o.params.cohesionRadiusColor,o.params.cohesionRadiusAlpha*3),t.fillStyle=N(o.params.cohesionRadiusColor,o.params.cohesionRadiusAlpha*.65),t.lineWidth=o.params.cohesionRadiusLineWidth,t.fill(),t.stroke()),o.params.visualizeCohesionToNeighbors&&n.forEach(a=>{t.beginPath(),t.moveTo(e.x,e.y),t.lineTo(a.x,a.y),t.strokeStyle=N(o.params.cohesionRadiusColor,o.params.cohesionRadiusAlpha*5),t.lineWidth=o.params.cohesionRadiusLineWidth,t.stroke()}))}function ye(e,n,t,a){a.length=0;const s=n.x,i=n.y,l=s[e],c=i[e];for(let h=0;h<s.length;h++){if(h===e)continue;at({x:l,y:c},{x:s[h],y:i[h]})<=t&&a.push({x:s[h],y:i[h]})}}function lt(e,n,t){!o.params.visualizeSeparationRadius&&!o.params.visualizeSeparationToNeighbors||(o.params.visualizeSeparationRadius&&(t.beginPath(),t.arc(e.x,e.y,o.params.separationRadius,0,Math.PI*2),t.strokeStyle=N(o.params.separationRadiusColor,o.params.separationRadiusAlpha*3),t.fillStyle=N(o.params.separationRadiusColor,o.params.separationRadiusAlpha*.2),t.lineWidth=o.params.separationRadiusLineWidth,t.fill(),t.stroke()),o.params.visualizeSeparationToNeighbors&&n.forEach(a=>{t.beginPath(),t.moveTo(e.x,e.y),t.lineTo(a.x,a.y),t.strokeStyle=N(o.params.separationRadiusColor,o.params.separationRadiusAlpha*5),t.lineWidth=o.params.separationRadiusLineWidth,t.stroke()}))}const Be=new WeakMap;function Ne(e){const n=Be.get(e);if(n)return n;const t=new Path2D,a=e.points;t.moveTo(a[0][0],a[0][1]);for(let s=1;s<a.length;s++)t.lineTo(a[s][0],a[s][1]);return t.closePath(),Be.set(e,t),t}function ct(){const e=Math.floor(Math.random()*360),n=60+Math.random()*30,t=45+Math.random()*30;return`hsl(${e}, ${n}%, ${t}%)`}function Re(e,n,t,a,s,i=s.size??1,l,c,h){const b=tt[a],C=Math.atan2(t.y,t.x)||0;e.save(),e.translate(n.x,n.y),e.rotate(C);const y=b.scale*i;e.scale(y,y);const v=(s.lineWidth??0)/y,g=e.globalAlpha;if(e.globalAlpha=1,l&&v>0){const x=v*(l.widthMul??1.6),w=l.alpha??.35,R=e.strokeStyle,M=e.lineWidth,T=e.globalAlpha;if(e.globalAlpha=w,e.strokeStyle=l.color,e.lineWidth=x,b.type==="circle"){const W=b.radius??4;e.beginPath(),e.arc(0,0,W,0,Math.PI*2),e.closePath(),e.stroke()}else{const W=Ne(b);e.stroke(W)}e.strokeStyle=R,e.lineWidth=M,e.globalAlpha=T}if(e.lineWidth=v,e.strokeStyle=h??s.stroke,e.fillStyle=c??s.fill,b.type==="circle"){const x=b.radius??4;e.beginPath(),e.arc(0,0,x,0,Math.PI*2),e.closePath(),e.fill(),v>0&&e.stroke()}else{const x=Ne(b);e.fill(x),v>0&&e.stroke(x)}e.globalAlpha=g,e.restore()}let B=null,se=null,O=1,pe=0,ue=0;function dt(e,n,t){const a=Math.max(1,window.devicePixelRatio||1),s=Math.max(1,Math.floor(n*a)),i=Math.max(1,Math.floor(t*a));(e.width!==s||e.height!==i)&&(e.width=s,e.height=i),O=a}function pt(e,n){const t=Math.max(1,Math.floor(e*O)),a=Math.max(1,Math.floor(n*O));B||(B=document.createElement("canvas"),se=B.getContext("2d")),(pe!==t||ue!==a)&&(pe=t,ue=a,B.width=pe,B.height=ue)}const V=[],Q=[],$=[],Z=[],ee=[],te=[],me=[];function ut(e,n,t){if(V.length!==e){V.length=e,Q.length=e,$.length=e,Z.length=e,ee.length=e,te.length=e,me.length=e;for(let a=0;a<e;a++){V[a]=n[a],Q[a]=t[a],$[a]=0,Z[a]=n[a],ee[a]=t[a];const s=ct();te[a]=s,me[a]=s}}}function mt(e,n,t,a){const s=n.clientWidth,i=n.clientHeight;dt(n,s,i),pt(s,i),o.needsFullCanvasReset&&(e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,n.width,n.height),se&&B&&(se.setTransform(1,0,0,1,0,0),se.clearRect(0,0,B.width,B.height)),V.length=0,Q.length=0,$.length=0,Z.length=0,ee.length=0,te.length=0,me.length=0,o.needsFullCanvasReset=!1);const l=o.arrays.position.x,c=o.arrays.position.y,h=o.arrays.velocity.x,b=o.arrays.velocity.y,C=l.length;ut(C,l,c);const y=se;y.setTransform(1,0,0,1,0,0),y.imageSmoothingEnabled=!1;const v=Math.max(1,o.params.trailStep??6),g=Math.max(s,i)*.45,w=(a.size??1)*o.params.size*O,R={...a,lineWidth:(a.lineWidth??0)*O},M=Math.min(1,Math.max(0,o.params.trailLength??1)),T=Math.pow(1-M,2.2);T>0&&(y.globalCompositeOperation="destination-out",y.fillStyle=`rgba(0,0,0,${T})`,y.fillRect(0,0,pe,ue),y.globalCompositeOperation="source-over");for(let r=0;r<C;r++){const E=V[r],D=Q[r],H=l[r],_=c[r],q=H-E,U=_-D,X=Math.hypot(q,U);if(!isFinite(X)||X>g){V[r]=H,Q[r]=_,Z[r]=H,ee[r]=_,$[r]=0;continue}$[r]+=X;const xe=X>0?q/X:0,ae=X>0?U/X:0;for(;$[r]>=v;){Z[r]+=xe*v,ee[r]+=ae*v,$[r]-=v;const we=o.params.randomTrailColors?te[r]:R.fill,Me=o.params.randomTrailColors?te[r]:R.stroke;Re(y,{x:Z[r]*O,y:ee[r]*O},{x:q,y:U},a.shape,R,w,{color:"#000",alpha:o.params.shadowOpacity,widthMul:o.params.shadowSize},we,Me)}V[r]=H,Q[r]=_}e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,n.width,n.height),e.imageSmoothingEnabled=!1,e.globalCompositeOperation="source-over",e.globalAlpha=1,e.drawImage(B,0,0),e.setTransform(O,0,0,O,0,0),e.globalCompositeOperation="source-over",e.globalAlpha=1;const W=(a.size??1)*o.params.size;for(let r=0;r<C;r++){const E=o.params.randomBoidColors?te[r]:void 0,D=o.params.randomBoidColors?me[r]:void 0;Re(e,{x:l[r],y:c[r]},{x:h[r],y:b[r]},a.shape,a,W,void 0,E,D)}const L=o.params.mouseRadius??0,p=o.params.attractMouse,d=o.params.showMouseRadius??!0,S=o.mouse;S&&S.inside&&L>0&&d&&(e.save(),e.beginPath(),e.arc(S.x,S.y,L,0,Math.PI*2),e.setLineDash([6,4]),e.lineWidth=1,e.strokeStyle=p?"rgba(0, 255, 0, 0.4)":"rgba(255, 0, 0, 0.4)",e.stroke(),e.setLineDash([]),e.restore());const m=[],f=o.params.debugSampleStride&&o.params.debugSampleStride>0?o.params.debugSampleStride:Math.max(1,Math.floor(C/200)),k=o.params.maxDebugNeighbors&&o.params.maxDebugNeighbors>0?o.params.maxDebugNeighbors:16;if(o.params.visualizeAlignmentRadius||o.params.visualizeAlignmentToNeighbors)for(let r=0;r<C;r+=f)m.length=0,ye(r,{x:l,y:c},o.params.alignmentRadius,m),m.length>k&&(m.length=k),it({x:l[r],y:c[r]},m,e);if(o.params.visualizeCohesionRadius||o.params.visualizeCohesionToNeighbors)for(let r=0;r<C;r+=f)m.length=0,ye(r,{x:l,y:c},o.params.cohesionRadius,m),m.length>k&&(m.length=k),rt({x:l[r],y:c[r]},m,e);if(o.params.visualizeSeparationRadius||o.params.visualizeSeparationToNeighbors)for(let r=0;r<C;r+=f)m.length=0,ye(r,{x:l,y:c},o.params.separationRadius,m),m.length>k&&(m.length=k),lt({x:l[r],y:c[r]},m,e)}const Xe={backgroundColor:"#000000",border:"1px solid #333333"},je=Object.fromEntries(Object.entries(ne).map(([e,n])=>[e,n.default]));function ht(){try{const e=localStorage.getItem("factoryPresets");if(!e)return;const n=JSON.parse(e);if(!n.default)return;const t=n.default;for(const a of Object.keys(t))state.params[a]=t[a];state.needsTrailReset=!0,state.needsBoidReinit=!0}catch(e){console.error("Failed to load default preset:",e)}}function ft(e,n){Object.assign(e.style,{backgroundColor:Xe.backgroundColor,border:Xe.border});const t=o.params;for(const i of Object.keys(je))i in t&&(t[i]=je[i]);t.perception??=t.perceptionRadius,t.wSeparation??=t.separationWeight,t.wAlignment??=t.alignmentWeight,t.wCohesion??=t.cohesionWeight,t.needsReseed=!0,o.needsBoidReinit=!0,o.needsTrailReset=!0;function a(){const i=window.devicePixelRatio||1,l=e.getBoundingClientRect(),c=Math.max(1,Math.floor(l.width*i)),h=Math.max(1,Math.floor(l.height*i)),b=o.viewport.width,C=o.viewport.height;e.width=c,e.height=h,n.setTransform(i,0,0,i,0,0);const y=c/b,v=h/C,g=o.arrays.position.x,x=o.arrays.position.y;for(let w=0;w<g.length;w++)g[w]*=y,x[w]*=v;o.viewport.width=c,o.viewport.height=h,o.needsTrailReset=!0}window.addEventListener("resize",()=>{a()});function s(i){i.addEventListener("pointermove",l=>{const{x:c,y:h}=Oe(i,l);o.mouse.x=c,o.mouse.y=h,o.mouse.inside=!0}),i.addEventListener("pointerenter",l=>{const{x:c,y:h}=Oe(i,l);o.mouse.x=c,o.mouse.y=h,o.mouse.inside=!0}),i.addEventListener("pointerleave",()=>{o.mouse.inside=!1})}a(),ht(),s(e)}function gt(e){if(e<=0)return{x:0,y:0};const n=Math.random()*Math.PI*2,t=Math.random()*e;return{x:Math.cos(n)*t,y:Math.sin(n)*t}}function bt(e,n,t,a){const{x:s,y:i}=n.position,{x:l,y:c}=n.velocity,h=s[e],b=i[e],C=t*t;let y=0,v=0,g=0;for(let w=0;w<s.length;w++){if(w===e)continue;const R=s[w]-h,M=i[w]-b;R*R+M*M<=C&&(y+=l[w],v+=c[w],g++)}if(!g)return{x:l[e],y:c[e]};const x=oe({x:y/g,y:v/g});return{x:x.x*a,y:x.y*a}}function Se(e,n,t,a,s){const i=n.x-t.x[e],l=n.y-t.y[e],c=nt({x:i,y:l},a);return{x:c.x*s,y:c.y*s}}function yt(e,n){const t=bt(e,n,o.params.alignmentRadius,o.params.maxSpeed);return Se(e,t,n.velocity,o.params.maxForce,o.params.wAlignment)}function Rt(e,n,t,a){const{x:s,y:i}=n.position,l=s[e],c=i[e],h=t*t;let b=0,C=0,y=0;for(let g=0;g<s.length;g++){if(g===e)continue;const x=s[g]-l,w=i[g]-c;x*x+w*w<=h&&(b+=s[g],C+=i[g],y++)}if(!y)return{x:0,y:0};const v=oe({x:b/y-l,y:C/y-c});return{x:v.x*a,y:v.y*a}}function St(e,n){const t=Rt(e,n,o.params.cohesionRadius,o.params.maxSpeed);return Se(e,t,n.velocity,o.params.maxForce,o.params.wCohesion)}function vt(e,n,t,a){const s=n.position.x,i=n.position.y,l=s[e],c=i[e],h=t*t;let b=0,C=0,y=0;for(let g=0;g<s.length;g++){if(g===e)continue;const x=l-s[g],w=c-i[g],R=x*x+w*w;if(R<=h){const M=Math.sqrt(R)||1;b+=x/M,C+=w/M,y++}}if(!y)return{x:0,y:0};const v=oe({x:b,y:C});return{x:v.x*a,y:v.y*a}}function xt(e,n){const t=vt(e,n,o.params.separationRadius,o.params.maxSpeed);return Se(e,t,n.velocity,o.params.maxForce,o.params.wSeparation)}function wt(e,n=o.fsm.state,t){if(n!=="running")return;const{wrapEdges:a,maxSpeed:s,turnRate:i,cohesionRadius:l,speedBoostAtEdges:c,turnBoostAtEdges:h,separationWeight:b,alignmentWeight:C,cohesionWeight:y,separationRadius:v,alignmentRadius:g,maxWanderForce:x,boidCount:w}=o.params,R=o.arrays.position.x,M=o.arrays.position.y,T=o.arrays.velocity.x,W=o.arrays.velocity.y;let L=R.length;const p=w??L;if(p>L){const u=t.clientWidth||t.width,le=t.clientHeight||t.height;for(let P=L;P<p;P++)R[P]=Math.random()*u,M[P]=Math.random()*le,T[P]=0,W[P]=0}else p<L&&(R.length=p,M.length=p,T.length=p,W.length=p);if(L=R.length,L===0)return;const d=1-Math.exp(-i*e);Y.angle+=(Math.random()-.5)*.2,Y.x=Math.cos(Y.angle),Y.y=Math.sin(Y.angle);const S=o.params.flockDriftStrength??.1,m=l??Math.min(t.clientWidth,t.clientHeight)*.5,f=c??0,k=h??0,r=380,E=u=>Math.min(1,Math.max(0,u)),D=E((o.params.mouseInfluence??0)*.1),H=E((v??0)/r),_=E((g??0)/r),q=E((l??0)/r),U=Math.min(t.clientWidth,t.clientHeight),ae=E(s/150*.2)*U*.5,Ve=E((x??0)/150)*ae;let he=0,fe=0;for(let u=0;u<L;u++)he+=R[u],fe+=M[u];he/=L,fe/=L;const z=o.params.boundaryMargin??200,Ce=o.params.boundaryStrength??15,re=o.mouse,ke=o.params.attractMouse,Ee=o.params.repelMouse,We=o.params.mouseRadius??0,qe=o.params.mouseAttractionWeight??0,Ue=o.params.mouseRepelWeight??0,Je=o.params.speedBoostFromMouse??0,Ge=o.params.turnBoostFromMouse??0;for(let u=0;u<L;u++){const le=yt(u,o.arrays),P=St(u,o.arrays),Le=xt(u,o.arrays),Ae=gt(Ve),J={x:Le.x*b*H+le.x*C*_+P.x*y*q+Ae.x+Y.x*S,y:Le.y*b*H+le.y*C*_+P.y*y*q+Ae.y+Y.y*S};let Ie=1,Te=1;if(re&&re.inside&&(ke||Ee)){const A=re.x-R[u],I=re.y-M[u],j=Math.hypot(A,I)||1e-4,F=(ke?qe:0)-(Ee?Ue:0);if(F!==0){const G=A/j,K=I/j,et=We>0?We:U,ge=E(1-j/et),be=Math.abs(F)*D,Pe=be*ge*ae,Fe=F>0?1:-1;J.x+=G*Pe*Fe,J.y+=K*Pe*Fe,Ie=1+Je*be*ge,Te=1+Ge*be*ge}}if(!a){let A=0,I=0;const j=t.clientWidth,F=t.clientHeight,G=R[u],K=M[u];G<z?A+=(z-G)/z:G>j-z&&(A-=(G-(j-z))/z),K<z?I+=(z-K)/z:K>F-z&&(I-=(K-(F-z))/z),J.x+=A*Ce,J.y+=I*Ce}let ce=1,de=1;if(m>0&&(f!==0||k!==0)){const A=he-R[u],I=fe-M[u],j=Math.hypot(A,I),F=Math.min(1,j/m);ce=1+F*f,de=1+F*k,D>0&&(ce+=D*f,de+=D*k)}ce*=Ie,de*=Te;const Ke=oe({x:T[u],y:W[u]});let Qe=oe({x:T[u]+J.x,y:W[u]+J.y});const Ze=Math.min(1,d*de),ze=oe(st(Ke,Qe,Ze)),De=ae*ce;if(T[u]=ze.x*De,W[u]=ze.y*De,R[u]+=T[u]*e,M[u]+=W[u]*e,a){const A=t.clientWidth,I=t.clientHeight;R[u]>A&&(R[u]=0),R[u]<0&&(R[u]=A),M[u]>I&&(M[u]=0),M[u]<0&&(M[u]=I)}else{const A=t.clientWidth,I=t.clientHeight;R[u]<0&&(R[u]=0),R[u]>A&&(R[u]=A),M[u]<0&&(M[u]=0),M[u]>I&&(M[u]=I)}}}function Mt(e){if(!o.params.needsReseed)return;const n=o.params.boidCount,t=o.arrays.position.x,a=o.arrays.position.y,s=o.arrays.velocity.x,i=o.arrays.velocity.y,l=t.length;if(n<l)t.length=n,a.length=n,s.length=n,i.length=n;else if(n>l){const c=e.clientWidth,h=e.clientHeight;for(let b=l;b<n;b++){t.push(Math.random()*c),a.push(Math.random()*h);const C=Math.random()*Math.PI*2;s.push(Math.cos(C)),i.push(Math.sin(C))}}o.params.needsReseed=!1}const Ct={triangle:{fill:"#f5f5f7",stroke:"#5ec8ff",lineWidth:6,shape:"triangle",size:2.5},circle:{fill:"#f5f5f7",stroke:"#ff6e6e",lineWidth:1,shape:"circle",size:1.65},diamond:{fill:"#3a3a3a",stroke:"#fff",lineWidth:1,shape:"diamond",size:2.25},cross:{fill:"#ffdd57",stroke:"#ffaa00",lineWidth:2,shape:"cross",size:1.5},cake:{fill:"#ff31e4",stroke:"#333",lineWidth:3,shape:"cake",size:2},kite:{fill:"#e1ffd4",stroke:"#4caf50",lineWidth:2,shape:"kite",size:2},chevron:{fill:"#fff0f5",stroke:"#ff69b4",lineWidth:2,shape:"chevron",size:2},leaf:{fill:"#d0f0c0",stroke:"#228b22",lineWidth:2,shape:"leaf",size:2},capsule:{fill:"#000000",stroke:"#ffbfba",lineWidth:2,shape:"capsule",size:2},wedge:{fill:"#fff5e1",stroke:"#ff8c00",lineWidth:2,shape:"wedge",size:2},particle:{fill:"#ffffff",stroke:"#ccc",lineWidth:1,shape:"circle",size:1},dot:{fill:"#ffffff",stroke:"#ffffff",lineWidth:.35,shape:"circle",size:.25}};function ve(e){const n=ne[e];if(!(!n||!n.affects))switch(n.affects){case"boid-structure":o.needsBoidReinit=!0;break;case"render-cache":o.needsTrailReset=!0;break}}function kt(e){const n=document.createElement("div"),t=document.createElement("label");t.textContent=e.label,t.htmlFor=e.paramId,n.appendChild(t);const a=document.createElement("input");a.type="range",a.id=e.paramId,a.min=String(e.min),a.max=String(e.max),e.step!=null&&(a.step=String(e.step));const s=o.params[e.paramId],i=(typeof s=="number"?s:void 0)??e.defaultValue??e.min;return a.value=String(i),a.addEventListener("input",()=>{o.params[e.paramId]=Number(a.value),ve(e.paramId)}),n.appendChild(a),n}function Et(e){const n=document.createElement("div"),t=document.createElement("label");t.textContent=e.label,t.htmlFor=e.paramId,n.appendChild(t);const a=document.createElement("select");a.id=e.paramId;for(const l of e.options){const c=document.createElement("option");c.value=String(l.value),c.textContent=l.label,a.appendChild(c)}const s=o.params[e.paramId],i=s??void 0??e.defaultValue??e.options[0].value;return a.value=String(i),a.addEventListener("change",()=>{o.params[e.paramId]=a.value,ve(e.paramId)}),n.appendChild(a),n}function Wt(e){const n=document.createElement("div"),t=document.createElement("label");t.textContent=e.label,t.htmlFor=e.paramId,n.appendChild(t);const a=document.createElement("input");a.type="checkbox",a.id=e.paramId;const s=o.params[e.paramId],i=(typeof s=="boolean"?s:void 0)??e.defaultValue??!1;return a.checked=i,a.addEventListener("input",()=>{o.params[e.paramId]=a.checked,ve(e.paramId)}),n.appendChild(a),n}function Lt(){const e=document.createElement("div"),n=document.createElement("div");return n.classList.add("spacer"),e.appendChild(n),e}function At(){try{const e=localStorage.getItem("boidPresets");if(!e)return{};const n=JSON.parse(e);return n&&typeof n=="object"?n:{}}catch{return{}}}function He(e){try{localStorage.setItem("boidPresets",JSON.stringify(e))}catch{}}function It(e){e.innerHTML="";const n=new Map,t=document.createElement("div");t.classList.add("preset-bar");const a=document.createElement("div");a.classList.add("preset-title"),a.textContent="Presets";const s=document.createElement("div");s.classList.add("preset-row");const i=document.createElement("select");i.classList.add("preset-select");const l=document.createElement("button");l.type="button",l.classList.add("preset-btn"),l.textContent="Load",s.appendChild(i),s.appendChild(l);const c=document.createElement("div");c.classList.add("preset-row");const h=document.createElement("input");h.type="text",h.classList.add("preset-name"),h.placeholder="Preset name";const b=document.createElement("button");b.type="button",b.classList.add("preset-btn"),b.textContent="Save",document.createElement("div").classList.add("preset-row");const y=document.createElement("button");y.type="button",y.classList.add("preset-btn"),y.textContent="Export";const v=document.createElement("button");v.type="button",v.classList.add("preset-btn"),v.textContent="Import";const g=document.createElement("input");g.type="file",g.accept="application/json",g.style.display="none",c.appendChild(h),c.appendChild(b),c.appendChild(y),c.appendChild(v),t.appendChild(a),t.appendChild(s),t.appendChild(c),t.appendChild(g),e.appendChild(t);let x=At();function w(){const p={};for(const d of Object.keys(ne))p[d]=o.params[d];return p}function R(){const p=i.value;i.innerHTML="";const d=Object.keys(x);d.includes("default")||d.unshift("default");for(const S of d){const m=document.createElement("option");m.value=S,m.textContent=S,i.appendChild(m)}p&&d.includes(p)?i.value=p:i.value="default"}function M(p){let d=x[p];if(!d&&p==="default"&&(d=w()),!!d){for(const[S,m]of Object.entries(d)){o.params[S]=m;const f=n.get(S);f&&(f instanceof HTMLSelectElement?(f.value=String(m),f.dispatchEvent(new Event("change",{bubbles:!0}))):f instanceof HTMLInputElement&&(f.type==="checkbox"?(f.checked=!!m,f.dispatchEvent(new Event("change",{bubbles:!0}))):(f.value=String(m),f.dispatchEvent(new Event("input",{bubbles:!0})))))}o.needsFullCanvasReset=!0,o.needsTrailReset=!0}}function T(p){const d=p.trim();if(!d)return;const S=w();x[d]=S,He(x),R(),i.value=d}R(),l.addEventListener("click",()=>{const p=i.value||"default";M(p)}),b.addEventListener("click",()=>{const p=h.value.trim()||i.value.trim()||"default";T(p)}),y.addEventListener("click",()=>{const p=h.value.trim()||i.value.trim()||"preset",d=w(),S=new Blob([JSON.stringify(d,null,2)],{type:"application/json"}),m=URL.createObjectURL(S),f=document.createElement("a");f.href=m,f.download=`${p}.json`,document.body.appendChild(f),f.click(),document.body.removeChild(f),URL.revokeObjectURL(m)}),v.addEventListener("click",()=>{g.click()}),g.addEventListener("change",()=>{const p=g.files?.[0];if(!p)return;const d=new FileReader;d.onload=()=>{try{const S=JSON.parse(String(d.result));if(!S||typeof S!="object")return;const f=p.name.replace(/\.json$/i,"")||"imported";x[f]=S,He(x),R(),i.value=f,M(f)}catch{}},d.readAsText(p),g.value=""});const W=new Map;function L(p){let d=W.get(p);if(!d){const S=document.createElement("section");S.classList.add("param-group");const m=document.createElement("button");m.type="button",m.classList.add("param-group-header");const f=document.createElement("span");f.classList.add("param-group-chevron"),f.textContent="▾";const k=document.createElement("span");k.classList.add("param-group-title"),k.textContent=p,m.appendChild(f),m.appendChild(k),S.appendChild(m);const r=document.createElement("div");r.classList.add("param-group-content"),S.appendChild(r),S.classList.add("collapsed"),m.addEventListener("click",()=>{const E=S.classList.toggle("collapsed");f.textContent=E?"▸":"▾"}),d={section:S,content:r},W.set(p,d)}return d.content}for(const[p,d]of Object.entries(ne)){if(d.control==="none")continue;const S=d.group??"Misc",m=L(S),f="label"in d?d.label??p:p;if(d.control==="slider"){const k={paramId:p,label:f,min:d.slider.min,max:d.slider.max,step:d.slider.step,defaultValue:d.default},r=kt(k);m.appendChild(r);const E=r.querySelector("input[type='range']");E&&n.set(p,E)}else if(d.control==="checkbox"){const k={paramId:p,label:f,defaultValue:d.default},r=Wt(k);m.appendChild(r);const E=r.querySelector("input[type='checkbox']");E&&n.set(p,E)}else if(d.control==="dropdown"){const k={paramId:p,label:f,options:d.dropdown.options.map(D=>({value:D,label:D})),defaultValue:d.default},r=Et(k);m.appendChild(r);const E=r.querySelector("select");E&&n.set(p,E)}else if(d.control==="spacer"){const k=Lt();m.appendChild(k)}}for(const{section:p,content:d}of W.values())d.children.length>0&&e.appendChild(p);x.default&&(i.value="default",M("default"))}document.querySelector("#app").innerHTML=`
  <div class="main-content">
    <div class="aside">
      <h1>Boids Simulation</h1>
      <div class="controls" id="ui-panel"></div>
    </div>
    <div class="canvasWrapper">
      <canvas id="boidsCanvas"></canvas>
    </div>
  </div>
`;const ie=document.getElementById("boidsCanvas"),Ye=ie.getContext("2d");o.fsm.state="running";ft(ie,Ye);window.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("ui-panel");if(!e){console.error("UI panel not found");return}It(e)});let _e=performance.now();function $e(e){const n=Math.max(0,Math.min(.05,(e-_e)/1e3));_e=e,Mt(ie),wt(n,o.fsm.state,ie);const t=Ct[o.params.theme];mt(Ye,ie,Re,t),requestAnimationFrame($e)}requestAnimationFrame($e);
